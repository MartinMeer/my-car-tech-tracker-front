<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Test ‚Äî My Car Tech Tracker</title>
  <link rel="stylesheet" href="../src/styles/styles.css">
  <style>
    .test-container {
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .test-button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    .test-button:hover {
      background: #2980b9;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üîê Authentication Test Page</h1>
    
    <div class="test-section">
      <h3>Current Authentication Status</h3>
      <div id="auth-status" class="status info">Checking...</div>
      <button class="test-button" onclick="checkAuthStatus()">Refresh Status</button>
    </div>
    
    <div class="test-section">
      <h3>localStorage Contents</h3>
      <div id="localStorage-content" class="status info">Loading...</div>
      <button class="test-button" onclick="showLocalStorage()">Show localStorage</button>
    </div>
    
    <div class="test-section">
      <h3>Cookie Handler Test</h3>
      <button class="test-button" onclick="testCookieHandler()">Test Cookie Handler</button>
      <div id="cookie-test-result" class="status info">Click button to test</div>
    </div>
    
    <div class="test-section">
      <h3>Quick Actions</h3>
      <button class="test-button" onclick="clearAllAuth()">Clear All Auth Data</button>
      <button class="test-button" onclick="setDemoAuth()">Set Demo Auth</button>
      <button class="test-button" onclick="goToMain()">Go to Main App</button>
      <button class="test-button" onclick="goToLogin()">Go to Login</button>
    </div>
    
    <div class="test-section">
      <h3>Debug Info</h3>
      <div id="debug-info" class="status info">Loading...</div>
    </div>
  </div>

  <script type="module">
    // Import modules
    import { CookieHandler } from '../src/cookieHandler.js';
    import { AuthService } from '../src/authService.js';
    
    // Make functions available globally
    window.CookieHandler = CookieHandler;
    window.AuthService = AuthService;
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Auth test page loaded');
      checkAuthStatus();
      showLocalStorage();
      showDebugInfo();
    });
    
    // Global functions
    window.checkAuthStatus = function() {
      const authStatus = document.getElementById('auth-status');
      
      try {
        const authServiceAuth = AuthService.isAuthenticated();
        const directAuthToken = localStorage.getItem('auth_token');
        const currentUser = localStorage.getItem('currentUser');
        
        let status = '';
        let className = 'info';
        
        if (authServiceAuth || directAuthToken) {
          status = '‚úÖ User is authenticated';
          className = 'success';
          
          if (currentUser) {
            try {
              const user = JSON.parse(currentUser);
              status += `<br>User: ${user.name || user.email} (ID: ${user.id})`;
            } catch (e) {
              status += '<br>User data available but could not parse';
            }
          }
        } else {
          status = '‚ùå User is not authenticated';
          className = 'error';
        }
        
        authStatus.innerHTML = status;
        authStatus.className = `status ${className}`;
        
      } catch (error) {
        authStatus.innerHTML = `‚ùå Error checking auth: ${error.message}`;
        authStatus.className = 'status error';
      }
    };
    
    window.showLocalStorage = function() {
      const content = document.getElementById('localStorage-content');
      
      try {
        const authItems = {};
        const allKeys = Object.keys(localStorage);
        
        // Filter auth-related items
        const authKeys = allKeys.filter(key => 
          key.includes('auth') || 
          key.includes('token') || 
          key.includes('user') || 
          key.includes('session') ||
          key.includes('cookie')
        );
        
        authKeys.forEach(key => {
          const value = localStorage.getItem(key);
          try {
            // Try to parse as JSON
            const parsed = JSON.parse(value);
            authItems[key] = typeof parsed === 'object' ? 
              `Object: ${JSON.stringify(parsed, null, 2)}` : 
              parsed;
          } catch (e) {
            // Not JSON, show as string
            authItems[key] = value;
          }
        });
        
        if (Object.keys(authItems).length === 0) {
          content.innerHTML = 'No auth-related items found in localStorage';
          content.className = 'status info';
        } else {
          let html = '<strong>Auth-related localStorage items:</strong><br>';
          Object.entries(authItems).forEach(([key, value]) => {
            html += `<strong>${key}:</strong> ${value}<br>`;
          });
          content.innerHTML = html;
          content.className = 'status success';
        }
        
      } catch (error) {
        content.innerHTML = `Error reading localStorage: ${error.message}`;
        content.className = 'status error';
      }
    };
    
    window.testCookieHandler = async function() {
      const result = document.getElementById('cookie-test-result');
      
      try {
        result.innerHTML = 'Testing...';
        result.className = 'status info';
        
        // Test basic cookie operations
        CookieHandler.setCookie('test_cookie', 'test_value');
        const value = CookieHandler.getCookie('test_cookie');
        const exists = CookieHandler.hasCookie('test_cookie');
        
        if (value === 'test_value' && exists) {
          result.innerHTML = '‚úÖ Cookie Handler working correctly';
          result.className = 'status success';
        } else {
          result.innerHTML = '‚ùå Cookie Handler test failed';
          result.className = 'status error';
        }
        
        // Cleanup
        CookieHandler.deleteCookie('test_cookie');
        
      } catch (error) {
        result.innerHTML = `‚ùå Cookie Handler error: ${error.message}`;
        result.className = 'status error';
      }
    };
    
    window.clearAllAuth = function() {
      try {
        // Clear AuthService
        AuthService.logout().catch(e => console.log('AuthService logout error:', e));
        
        // Clear direct localStorage
        localStorage.removeItem('auth_token');
        localStorage.removeItem('session_id');
        localStorage.removeItem('user_id');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('demoUsers');
        
        // Clear cookie-related items
        const keys = Object.keys(localStorage);
        keys.forEach(key => {
          if (key.startsWith('cookie_')) {
            localStorage.removeItem(key);
          }
        });
        
        alert('All authentication data cleared!');
        checkAuthStatus();
        showLocalStorage();
        
      } catch (error) {
        alert('Error clearing auth data: ' + error.message);
      }
    };
    
    window.setDemoAuth = function() {
      try {
        const mockToken = 'demo_token_' + Date.now();
        const mockSessionId = 'demo_session_' + Date.now();
        
        localStorage.setItem('auth_token', mockToken);
        localStorage.setItem('session_id', mockSessionId);
        localStorage.setItem('user_id', '1');
        localStorage.setItem('currentUser', JSON.stringify({
          id: 1,
          email: 'demo@example.com',
          name: 'Demo User',
          role: 'user',
          token: mockToken,
          sessionId: mockSessionId
        }));
        
        alert('Demo authentication set!');
        checkAuthStatus();
        showLocalStorage();
        
      } catch (error) {
        alert('Error setting demo auth: ' + error.message);
      }
    };
    
    window.goToMain = function() {
      window.location.href = 'index.html';
    };
    
    window.goToLogin = function() {
      window.location.href = 'auth/login.html';
    };
    
    window.showDebugInfo = function() {
      const debugInfo = document.getElementById('debug-info');
      
      try {
        const info = {
          'User Agent': navigator.userAgent,
          'Current URL': window.location.href,
          'localStorage Available': typeof Storage !== "undefined",
          'sessionStorage Available': typeof sessionStorage !== "undefined",
          'Cookies Available': navigator.cookieEnabled
        };
        
        let html = '<strong>Debug Information:</strong><br>';
        Object.entries(info).forEach(([key, value]) => {
          html += `<strong>${key}:</strong> ${value}<br>`;
        });
        
        debugInfo.innerHTML = html;
        
      } catch (error) {
        debugInfo.innerHTML = `Error getting debug info: ${error.message}`;
        debugInfo.className = 'status error';
      }
    };
  </script>
</body>
</html> 