---
import Layout from '../layouts/Layout.astro';
---

<Layout title="–ò—Å—Ç–æ—Ä–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è ‚Äî My Car Tech Tracker">
  <section class="service-history">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h1>–ò—Å—Ç–æ—Ä–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</h1>
    </div>
    <p class="page-description">–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∏ —Ä–µ–º–æ–Ω—Ç–∞ –ø–æ –≤—Å–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º</p>
    <div id="service-history-list">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è...</div>
    </div>
    <div style="display: flex; justify-content: center; margin-top: 2rem;">
      <button onclick="window.location.href='/cars/my-car-overview'" class="btn-primary" style="padding: 0.7rem 2rem; font-size: 1rem;">
        ‚Üê –ö –æ–±–∑–æ—Ä—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è
      </button>
    </div>
  </section>
</Layout>

<script type="module">
  import { DataService } from '/src/dataService.js';
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Service history page loaded, loading data...');
    try {
      loadServiceHistory();
    } catch (error) {
      console.error('Error loading service history:', error);
      showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è');
    }
  });

  async function loadServiceHistory() {
    const historyList = document.getElementById('service-history-list');
    if (!historyList) return;

    try {
      // Show loading state
      historyList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è...</div>';
      
      // Load service history data
      const serviceHistory = await DataService.getServiceHistory();
      
      if (!serviceHistory || serviceHistory.length === 0) {
        historyList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <h3>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</h3>
            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ–± –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏</p>
            <button class="btn-primary" onclick="window.location.href='/service-card'">
              <span class="icon">üîß</span>
              –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
            </button>
          </div>
        `;
        return;
      }
      
      // Render service history
      const historyHTML = serviceHistory.map(record => `
        <div class="service-record-item">
          <div class="service-record-header">
            <h3>${record.carName || '–ê–≤—Ç–æ–º–æ–±–∏–ª—å'}</h3>
            <span class="service-date">${record.date}</span>
          </div>
          <div class="service-record-details">
            <p><strong>–ü—Ä–æ–±–µ–≥:</strong> ${record.mileage} –∫–º</p>
            <p><strong>–û–ø–µ—Ä–∞—Ü–∏–∏:</strong> ${record.operations?.length || 0}</p>
          </div>
        </div>
      `).join('');
      
      historyList.innerHTML = historyHTML;
      
    } catch (error) {
      console.error('Error loading service history:', error);
      historyList.innerHTML = `
        <div class="error-state">
          <div class="error-icon">‚ùå</div>
          <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
          <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</p>
          <button class="btn-primary" onclick="location.reload()">
            <span class="icon">üîÑ</span>
            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
          </button>
        </div>
      `;
    }
  }

  function showError(message) {
    const historyList = document.getElementById('service-history-list');
    if (historyList) {
      historyList.innerHTML = `
        <div class="error-state">
          <div class="error-icon">‚ùå</div>
          <h3>–û—à–∏–±–∫–∞</h3>
          <p>${message}</p>
        </div>
      `;
    }
  }
</script> 